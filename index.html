<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Star Classification</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <style>
        body {
            padding: 20px;
        }
        h1 {
            margin-bottom: 20px;
        }
        .image-card {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
        }
        #imagePreview {
            max-height: 300px;
            width: 100%;
        }
        #label-container div {
            margin-bottom: 10px;
        }
    </style>
</head>
<body style="padding: 0px;">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">Star Classification</a>
			<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarSupportedContent">
				<ul class="navbar-nav me-auto mb-2 mb-lg-0">
				  <li class="nav-item">
					<a class="nav-link active" aria-current="page" href="#">Home</a>
				  </li>
				  <li class="nav-item">
					<a class="nav-link" href="about.html">About</a>
				  </li>
				</ul>
			  </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-6">
                <h1 class="mb-4 text-center">Upload an Image</h1>
                <div class="mb-3">
                    <label for="imageUpload" class="form-label">Choose a file:</label>
                    <input id="imageUpload" type="file" class="form-control">
                </div>
				<div class="row">
					<div class="col" style="width: 0px;"></div>
					<div class="col">
						<div class="image-card mb-4" style="height: 300px; width: 300px; display: none;" id="imagePreviewCard">
							<img id="imagePreview" class="img-fluid" alt="Preview Image">
						</div>
					</div>
					<div class="col" style="width: 0px;"></div>
				</div>
            </div>
            <div class="col-md-6">
                <div class="mb-4">
                    <h3 class="text-center">Classification Results</h3>
                    <div id="label-container" class="text-center"></div>
					<div id="resultPlace"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/dojo/1.14.1/dojo/dojo.js"></script>
	<script type="text/javascript">
		const URL = 'https://storage.googleapis.com/tm-model/3Qe6xLKFT/';

		let model, labelContainer, maxPredictions;

		// Load the image model
		async function init() {
			const modelURL = URL + 'model.json';
			const metadataURL = URL + 'metadata.json';

			// load the model and metadata
			model = await tmImage.load(modelURL, metadataURL);
			
			maxPredictions = model.getTotalClasses();

			labelContainer = document.getElementById('label-container');
			for (let i = 0; i < maxPredictions; i++) {
				// and class labels
				labelContainer.appendChild(document.createElement('div'));
			}
		}

		async function predict(isRequest) {
			var image = document.getElementById('imagePreview');
			const prediction = await model.predict(image, false);
			for (let i = 0; i < maxPredictions; i++) {
				labelContainer.childNodes[i].innerHTML = "";
			}
			for (let i = 0; i < maxPredictions; i++) {
				labelContainer.childNodes[i].style.color = 'black';
				labelContainer.childNodes[i].style.fontWeight = 'normal';
			}
			for (let i = 0; i < maxPredictions; i++) {
				const classPrediction = prediction[i].className + ': ' + prediction[i].probability.toFixed(4);
				labelContainer.childNodes[i].innerHTML = classPrediction;
			}
			let maxIndex = 0;
			for (let i = 0; i < maxPredictions; i++) {
				if (prediction[i].probability.toFixed(4) > prediction[maxIndex].probability.toFixed(4)) {
					maxIndex = i;
				}
			}
			labelContainer.childNodes[maxIndex].style.color = 'green';
			labelContainer.childNodes[maxIndex].style.fontWeight = 'bold';
			document.getElementById('resultPlace').innerHTML = '<h3 id="result" class="text-center" style="font-weight: bold;"></h3>';
			document.getElementById('result').innerHTML = 'Result: ' + prediction[maxIndex].className + '<br><h4>Confidence: ' + (prediction[maxIndex].probability.toFixed(4) * 100) + '%</h4>';
			return {
				result: prediction[maxIndex].className,
				isRequest: isRequest
			};
		}
	</script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script type="text/javascript">
		function readURL(input) {
			if (input.files && input.files[0]) {
				var reader = new FileReader();
				reader.onload = function (e) {
					$('#imagePreview').attr('src', e.target.result);
					// $('#imagePreview').css('background-image', 'url(' + e.target.result + ')');
					document.getElementById("imagePreviewCard").style.display = "block";
					$('#imagePreview').hide();
					$('#imagePreview').fadeIn(650);
				};
				reader.readAsDataURL(input.files[0]);
				init().then(() => {
					predict(false);
				});
			}
		}

		async function requestResult() {
			await init();

			let isRequest = false;
			if (window.location.href.includes('?request=true&image=')) {
				isRequest = true;
			}
			let src = window.location.href.split('?request=true&image=')[1];
			console.log(src);
			src = await fetch(src).then(r => r.blob());
			let reader = new FileReader();
			reader.onload = (e) => {
				console.log(e.target.result);
			}
			let imageSrc = "data:image/jpeg;base64," + reader.readAsBinaryString(src);
			console.log(imageSrc);
			if (isRequest) {
				$('#imagePreview').attr('src', imageSrc);
				document.getElementById("imagePreviewCard").style.display = "block";
				$('#imagePreview').hide();
				$('#imagePreview').fadeIn(650);
			}
			console.log(isRequest);
			console.log(document.getElementById('imagePreview'));
			// predict(isRequest).then((result) => {
			// 	if (result['isRequest']) {
			// 		// document.body.innerHTML = result["result"];
			// 		console.log(result["result"]);
			// 	}
			// });
			setTimeout(() => {
				predict(isRequest).then((result) => {
					if (result['isRequest']) {
						document.body.innerHTML = result["result"];
						console.log(result["result"]);
					}
				});
			}, 0);
		}
		
		if (window.location.href.includes('?request=true&image=')) {
			let res = requestResult();
		}

		$('#imageUpload').change(function () {
			readURL(this);
		});
	</script>
</body>
</html>